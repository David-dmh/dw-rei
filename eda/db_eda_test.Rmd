```{r Set WDir}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

```{r Imports}
# install.packages("Rcpp")
# install.packages("DBI")
# install.packages("RPostgres")
library(plyr)
library(RPostgres)
library(DBI)
library(tidyverse)
library(ggmap)
library(sqldf)
library(sf)
library(mapview)
```

```{r API}
# ?register_google
register_google(key=Sys.getenv("Google_Maps_Platform_API_Key"))
```

```{r DB connection - need to point to prod}
con <- dbConnect(RPostgres::Postgres(), 
                 host="localhost",
                 port="5432",
                 dbname="REI_Stage",
                 user="postgres",
                 password=rstudioapi::askForPassword("Database password"))

# dbExistsTable(con, "factListings")
```

```{r Get data}
# df_factListings <- dbGetQuery(con, "
# 
# SELECT 
# * 
# FROM 
# public.\"factListings\"
# ;
# 
# ")

dimProperty <- dbGetQuery(con, "

SELECT 
* 
FROM 
public.\"dimProperty\"
;

")

dimProperty
```

```{r Get existing geocoded values from cache}
dimProperty_fll <- read.csv("geocoded_loc_ref.csv")
dimProperty_fll
```

```{r RUN THIS IF NO CACHE FILE}
# dimProperty_fll <- mutate_geocode(subset(dimProperty, select=c("full_address")), full_address)
# colnames(dimProperty_fll) <- c("full_address", "longitude", "latitude")
# 
## geocode failed:
# sqldf("
#           SELECT
#           *
#           FROM
#           dimProperty_fll
#           WHERE
#           (longitude IS NULL AND latitude IS NULL)
#           ;
#           ")
# 
# # save scrape
# write.csv(dimProperty_fll,
# "C:/Users/User/Documents/FINANCES_CAREER/ONLINE_BUSINESS/Backend_API_v2/eda/geocoded_loc_ref.csv",
# row.names=FALSE)
```

```{r Comp between cached and dimProp}
dim(dimProperty)[1]
dim(dimProperty_fll)[1]
```

```{r View addresses not in cache to geocode}
# to geocode includes:
# - previously failed-to-geocode records (not written to cache file)
# - new properties recently added to dimProperty

# may need to add failures to cache if always fail to geocode as this may 
# cause slow processing times as the dimension grows

to_geocode <- sqldf("
          SELECT
          full_address
          FROM
          dimProperty
          
          EXCEPT
          
          SELECT
          full_address
          FROM
          dimProperty_fll
          ;
          ")
to_geocode
```

```{r}
# attempt to geocode failed_geocode and reformat like cache
# 3 attempts to avoid API connectivity issues
r <- NULL
attempt <- 0
while(is.null(r) && attempt <= 3) {
  attempt <- attempt + 1
  try(
    df_dimProperty_fas_ll_new <- mutate_geocode(
      subset(to_geocode, select=c("full_address")),
      full_address
      )
  )
}
try(
  df_dimProperty_fll_new
)
```

```{r}
if(exists("df_dimProperty_fll_new")){
  # non-empty = write
  # merge with cached if above results are non-empty 
dimProperty_fll_merged <- merge(x=dimProperty_fll, 
                                y=df_dimProperty_fll_new, 
                                by="full_address", 
                                all=TRUE)

# reformat
skew_rows <- which(!is.na(dimProperty_fll_merged[, 4])) 

# shift .y's left
if(length(skew_rows) != 0){
  for(i in skew_rows){
  dimProperty_fll_merged[i, 2:3] <- dimProperty_fll_merged[i, 4:5]
  }
}

# discard old columnns
dimProperty_fll_merged <- subset(dimProperty_fll_merged, select=c("full_address", "longitude", "latitude"))

# update cache
write.csv(dimProperty_fll_merged,
          "C:/Users/User/Documents/FINANCES_CAREER/ONLINE_BUSINESS/Backend_API_v2/eda/geocoded_loc_ref.csv",
          row.names=FALSE)

# view new
dimProperty_fll_merged
} else {
  print("No new geocoded data, not updating cache")
}
```

```{r}
# this data ready for analysis, just need to exclude nulls for plot
df <- read.csv("geocoded_loc_ref.csv")
df
```

```{r}
# # remove nulls (if applicable - if add failed geocode to cache)
# df <- sqldf("
#           SELECT 
#           * 
#           FROM 
#           df
#           WHERE 
#           (longitude IS NOT NULL OR latitude IS NOT NULL)
#           ;
#           ")
# df
```

```{r}
# check that the geocoding done correctly with mapview
locations_sf <- st_as_sf(df, 
                         coords=c("longitude", "latitude"), 
                         crs=4326)
locations_sf
```

```{r}
# POC map
mapview(locations_sf)
```
