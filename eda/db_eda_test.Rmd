```{r Imports}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path));

# install.packages("Rcpp")  
# install.packages("DBI")
# install.packages("RPostgres")
library(plyr)
library(RPostgres)
library(DBI)
library(tidyverse)
library(ggmap)
library(sqldf)
library(useful)
library(sf)
library(mapview)
# library(retry)

```

```{r API}
# ?register_google
register_google(key=Sys.getenv("Google_Maps_Platform_API_Key"))
```

```{r DB connection - need to point to prod}
con <- dbConnect(RPostgres::Postgres(), 
                 host="localhost",
                 port="5432",
                 dbname="REI_Stage",
                 user="postgres",
                 password=rstudioapi::askForPassword("Database password"))

# dbExistsTable(con, "factListings")
```

```{r Get data}
# df_factListings <- dbGetQuery(con, "
# 
# SELECT 
# * 
# FROM 
# public.\"factListings\"
# ;
# 
# ")

df_dimProperty <- dbGetQuery(con, "

SELECT 
* 
FROM 
public.\"dimProperty\"
;

")

df_dimProperty
```

```{r Get geocoded values}
# # RUN THIS IF NO CACHE FILE:
# df_dimProperty_fas_ll <- mutate_geocode(subset(df_dimProperty, select=c("full_address")), full_address)
# colnames(df_dimProperty_fas_ll) <- c("full_address", "longitude", "latitude")

# or 
# read existing from cache:
# df_dimProperty_fas_ll <- read.csv("C:/Users/User/Documents/FINANCES_CAREER/ONLINE_BUSINESS/Backend_API_v2/eda/geocoded_loc_ref.csv")
df_dimProperty_fas_ll
```
```{r}
# # RUN THIS IF NO CACHE FILE
# df_no_missing <- sqldf("
#           SELECT 
#           * 
#           FROM 
#           df_dimProperty_fas_ll
#           WHERE 
#           (longitude IS NOT NULL AND latitude IS NOT NULL)
#           ;
#           ")
# # df_no_missing
# 
# write.csv(df_no_missing,
#           "C:/Users/User/Documents/FINANCES_CAREER/ONLINE_BUSINESS/Backend_API_v2/eda/geocoded_loc_ref.csv",
#           row.names=FALSE)
```


```{r API could not geocode these}
# sqldf("
#           SELECT
#           *
#           FROM
#           df_dimProperty_fas_ll
#           WHERE
#           (longitude IS NULL AND latitude IS NULL)
#           ;
#           ")
```

```{r Comp between cached and dimProp}
dim(df_dimProperty)[1]
dim(df_dimProperty_fas_ll)[1]
```

```{r}
# need to keep ref csv
# do left outer join where left table is incoming addresses
# thereby only geocode addresses which don't exist in ref
# since these have already been geocoded
df_non_geocoded <- sqldf("
          SELECT 
          dp.full_address 
          FROM 
          df_dimProperty dp
          LEFT JOIN
          df_dimProperty_fas_ll dpll
          ON
          dp.full_address = dpll.full_address
          WHERE 
          (dpll.latitude IS NULL AND dpll.longitude IS NULL)
          ;
          ")
df_non_geocoded
```



```{r}
# geocode new, nongeocoded here using mutate_geocode and reformat like cached
r <- NULL
attempt <- 0
while(is.null(r) && attempt <= 3) {
  attempt <- attempt + 1
  try(
    df_dimProperty_fas_ll_new <- mutate_geocode(
      subset(df_non_geocoded, select=c("full_address")),
      full_address
      )
  )
}

df_dimProperty_fas_ll_new
```

```{r}
# merge with cached 
df_dimProperty_fas_ll_merged <- merge(x=df_dimProperty_fas_ll, 
                                      y=df_dimProperty_fas_ll_new, 
                                      by="full_address", 
                                      all=TRUE)
df_dimProperty_fas_ll_merged
```

```{r Clean updated df}
skew_rows <- which(!is.na(df_dimProperty_fas_ll_merged[, 4])) 

# shift .y's left
if(length(skew_rows) != 0){
  for(i in skew_rows){
  df_dimProperty_fas_ll_merged[i, 2:3] <- df_dimProperty_fas_ll_merged[i, 4:5]
  }
}

# discard old columnns
df_dimProperty_fas_ll_merged <- subset(df_dimProperty_fas_ll_merged, select=c("full_address", "longitude", "latitude"))

df_dimProperty_fas_ll_merged
```

```{r Write out new}
write.csv(df_dimProperty_fas_ll_merged,
          "C:/Users/User/Documents/FINANCES_CAREER/ONLINE_BUSINESS/Backend_API_v2/eda/geocoded_loc_ref.csv",
          row.names=FALSE)
```


```{r}
# remember to remove NULL lat and lon from geocoded df,API doesnt find all due to 
# e.g. 1A and 2A Church Street

# this data ready for analysis, just need to exclude nulls for plot
df <- read.csv("C:/Users/User/Documents/FINANCES_CAREER/ONLINE_BUSINESS/Backend_API_v2/eda/geocoded_loc_ref.csv")
df
```

```{r}
# remove nulls
df <- sqldf("
          SELECT 
          * 
          FROM 
          df
          WHERE 
          (longitude IS NOT NULL OR latitude IS NOT NULL)
          ;
          ")
df
```


```{r}
# check that the geocoding done correctly with mapview
locations_sf <- st_as_sf(df, 
                         coords=c("longitude", "latitude"), 
                         crs=4326)
locations_sf
```

```{r}
mapview(locations_sf)
```

